<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Construction Tracker (Multi-Project)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Sarabun', sans-serif; background: #f4f7f6; overflow: hidden; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #2c3e50; color: white; height: 50px; }
        
        /* สไตล์สำหรับระบบ Tab */
        .project-tabs { display: flex; background: #34495e; overflow-x: auto; padding: 5px 10px; gap: 5px; align-items: center; }
        .tab { background: #5d6d7e; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 4px 4px 0 0; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .tab.active { background: #ecf0f1; color: #2c3e50; font-weight: bold; }
        .btn-add-tab { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 50%; cursor: pointer; }
        .btn-del-tab { color: #e74c3c; cursor: pointer; font-size: 12px; }

        #map-container { height: 45vh; width: 100%; position: relative; border-bottom: 3px solid #ddd; }
        #map { height: 100%; width: 100%; }
        .summary-section { padding: 15px; height: calc(55vh - 110px); overflow-y: auto; background: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-online { background: #27ae60; color: white; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
        .zone-label { background: rgba(255, 255, 255, 0.9); border: 1px solid #333; border-radius: 4px; padding: 2px 6px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div><strong><i class="fa-solid fa-earth-americas"></i> Site Online</strong></div>
        <div class="btn-group">
            <button class="btn-online" id="status-cloud">เชื่อมต่อสำเร็จ</button>
            <button onclick="document.getElementById('uploadInput').click()" style="padding:6px; cursor:pointer;"><i class="fa-solid fa-image"></i> แบบ</button>
            <input type="file" id="uploadInput" accept="image/*" style="display:none">
        </div>
    </div>

    <div class="project-tabs" id="tabList">
        <button class="btn-add-tab" onclick="addProject()">+</button>
    </div>

    <div id="map-container"><div id="map"></div></div>

    <div class="summary-section">
        <h3><i class="fa-solid fa-list-check"></i> ตารางสรุปงาน (Real-time)</h3>
        <table id="progressTable">
            <thead>
                <tr>
                    <th>Zone</th>
                    <th>สถานะ</th>
                    <th>จัดการ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCUKIYKjC-bYpNm3o0iJxkQu04vek1W9eI",
            authDomain: "house-45.firebaseapp.com",
            databaseURL: "https://house-45-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "house-45",
            storageBucket: "house-45.firebasestorage.app",
            messagingSenderId: "147246420892",
            appId: "1:147246420892:web:7d84b9ad7337c9e1662e59",
            measurementId: "G-2L3KJ31NC8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentProjectId = 'project1'; // Default ID
        let allZones = {};
        let imageOverlay;

        const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 4 });
        map.pm.addControls({ position: 'topleft', drawCircle: false, drawMarker: false });

        // --- ระบบจัดการโครงการ (Tabs) ---
        const projectsRef = db.ref('projects');

        function loadProjects() {
            projectsRef.on('value', (snapshot) => {
                const projects = snapshot.val();
                const tabList = document.getElementById('tabList');
                tabList.innerHTML = '';
                
                if (projects) {
                    Object.keys(projects).forEach(id => {
                        const tab = document.createElement('button');
                        tab.className = `tab ${id === currentProjectId ? 'active' : ''}`;
                        tab.innerHTML = `<span>${projects[id].name}</span> <i class="fa-solid fa-xmark btn-del-tab" onclick="deleteProject(event, '${id}')"></i>`;
                        tab.onclick = () => switchProject(id);
                        tabList.appendChild(tab);
                    });
                }
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-add-tab';
                addBtn.innerHTML = '+';
                addBtn.onclick = addProject;
                tabList.appendChild(addBtn);
            });
        }

        function addProject() {
            const name = prompt("ชื่อโครงการใหม่:");
            if (name) {
                const newRef = projectsRef.push();
                newRef.set({ name: name });
                switchProject(newRef.key);
            }
        }

        function deleteProject(e, id) {
            e.stopPropagation();
            if (confirm("ลบโครงการนี้และข้อมูลทั้งหมดในโครงการ?")) {
                db.ref(`data/${id}`).remove();
                projectsRef.child(id).remove();
            }
        }

        function switchProject(id) {
            currentProjectId = id;
            // ยกเลิก Listener เก่า
            db.ref(`data/${currentProjectId}`).off();
            initDataSync();
            loadProjects(); // เพื่อ Update UI tab active
        }

        // --- การ Sync ข้อมูลตาม Project ID ---
        function initDataSync() {
            const currentDataRef = db.ref(`data/${currentProjectId}`);
            
            // เคลียร์หน้าจอ
            Object.values(allZones).forEach(layer => map.removeLayer(layer));
            allZones = {};
            if (imageOverlay) map.removeLayer(imageOverlay);
            renderTable();

            // ฟังข้อมูล Zones
            currentDataRef.child('zones').on('value', (snapshot) => {
                const data = snapshot.val();
                Object.values(allZones).forEach(layer => map.removeLayer(layer));
                allZones = {};
                if (data) {
                    Object.keys(data).forEach(id => {
                        const item = data[id];
                        const layer = L.geoJSON(item.geoJSON).getLayers()[0];
                        renderZoneFromServer(layer, id, item.name, item.isDone);
                    });
                }
                renderTable();
            });

            // ฟังรูปภาพ
            currentDataRef.child('planImage').on('value', (snapshot) => {
                const url = snapshot.val();
                if (url) loadImageToMap(url);
            });
        }

        // --- ส่วนการทำงานแผนที่ (อ้างอิง currentProjectId) ---
        map.on('pm:create', (e) => {
            const zoneName = prompt("ชื่อพื้นที่:");
            if (zoneName) {
                const newZoneRef = db.ref(`data/${currentProjectId}/zones`).push();
                newZoneRef.set({
                    name: zoneName,
                    isDone: false,
                    geoJSON: e.layer.toGeoJSON()
                });
            }
            map.removeLayer(e.layer);
        });

        function renderZoneFromServer(layer, id, name, isDone) {
            layer.zoneId = id;
            layer.zoneName = name;
            layer.isDone = isDone;
            layer.addTo(map);
            layer.bindTooltip(name, { permanent: true, direction: 'center', className: 'zone-label' });
            layer.setStyle(isDone ? {color:'#27ae60',fillColor:'#2ecc71',fillOpacity:0.6} : {color:'gray',fillColor:'gray',fillOpacity:0.3});
            allZones[id] = layer;
            layer.on('click', () => {
                if(map.pm.globalEditModeEnabled()) return;
                db.ref(`data/${currentProjectId}/zones/${id}`).update({ isDone: !isDone });
            });
        }

        document.getElementById('uploadInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => db.ref(`data/${currentProjectId}/planImage`).set(ev.target.result);
            reader.readAsDataURL(file);
        });

        function loadImageToMap(url) {
            const img = new Image();
            img.onload = () => {
                if (imageOverlay) map.removeLayer(imageOverlay);
                const bounds = [[0, 0], [img.height, img.width]];
                imageOverlay = L.imageOverlay(url, bounds).addTo(map);
                map.fitBounds(bounds);
            };
            img.src = url;
        }

        function renderTable() {
            const tbody = document.querySelector('#progressTable tbody');
            tbody.innerHTML = '';
            Object.keys(allZones).forEach(id => {
                const layer = allZones[id];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${layer.zoneName}</strong></td>
                    <td>
                        <input type="checkbox" ${layer.isDone ? 'checked' : ''} onchange="toggleZone('${id}', ${layer.isDone})">
                        ${layer.isDone ? 'เสร็จ' : 'รอดำเนินการ'}
                    </td>
                    <td>
                        <button onclick="deleteZone('${id}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleZone(id, currentStatus) {
            db.ref(`data/${currentProjectId}/zones/${id}`).update({ isDone: !currentStatus });
        }

        function deleteZone(id) {
            if(confirm('ลบพื้นที่นี้?')) db.ref(`data/${currentProjectId}/zones/${id}`).remove();
        }

        // เริ่มต้นทำงาน
        loadProjects();
        initDataSync();
    </script>
</body>
</html>
