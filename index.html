<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Online Construction Tracker</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* CSS เหมือนเดิมจากเวอร์ชันก่อนหน้า */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Sarabun', sans-serif; background: #f4f7f6; overflow: hidden; }
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #2c3e50; color: white; height: 50px; }
        #map-container { height: 50vh; width: 100%; position: relative; border-bottom: 3px solid #ddd; }
        #map { height: 100%; width: 100%; }
        .summary-section { padding: 15px; height: calc(50vh - 70px); overflow-y: auto; background: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .btn-online { background: #27ae60; color: white; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
        .zone-label { background: rgba(255, 255, 255, 0.9); border: 1px solid #333; border-radius: 4px; padding: 2px 6px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-nav">
        <div><strong><i class="fa-solid fa-earth-americas"></i> Site Online</strong></div>
        <div class="btn-group">
            <button class="btn-online" id="status-cloud">เชื่อมต่อสำเร็จ</button>
            <button onclick="document.getElementById('uploadInput').click()" style="padding:6px; cursor:pointer;"><i class="fa-solid fa-image"></i> แบบ</button>
            <input type="file" id="uploadInput" accept="image/*" style="display:none">
        </div>
    </div>

    <div id="map-container"><div id="map"></div></div>

    <div class="summary-section">
        <h3><i class="fa-solid fa-list-check"></i> ตารางสรุปงาน (Real-time)</h3>
        <table id="progressTable">
            <thead>
                <tr>
                    <th>Zone</th>
                    <th>สถานะ</th>
                    <th>จัดการ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>

    <script>
        // *** ใส่ Firebase Config ของคุณที่นี่ ***
        const firebaseConfig = {
  apiKey: "AIzaSyCUKIYKjC-bYpNm3o0iJxkQu04vek1W9eI",
  authDomain: "house-45.firebaseapp.com",
  databaseURL: "https://house-45-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "house-45",
  storageBucket: "house-45.firebasestorage.app",
  messagingSenderId: "147246420892",
  appId: "1:147246420892:web:7d84b9ad7337c9e1662e59",
  measurementId: "G-2L3KJ31NC8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const zonesRef = db.ref('zones');
        const imageRef = db.ref('planImage');

        const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 4 });
        map.pm.addControls({ position: 'topleft', drawCircle: false, drawMarker: false });

        let allZones = {}; // เก็บเป็น Object เพื่ออ้างอิง ID จาก Firebase
        let imageOverlay;

        // --- 1. ฟังข้อมูลแบบ Real-time (เมื่อคนอื่นแก้ เราจะเห็นด้วย) ---
        zonesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            // เคลียร์แผนที่และตารางก่อนโหลดใหม่
            Object.values(allZones).forEach(layer => map.removeLayer(layer));
            allZones = {};
            
            if (data) {
                Object.keys(data).forEach(id => {
                    const item = data[id];
                    const layer = L.geoJSON(item.geoJSON).getLayers()[0];
                    renderZoneFromServer(layer, id, item.name, item.isDone);
                });
            }
            renderTable();
        });

        // ฟังรูปภาพแบบแปลน
        imageRef.on('value', (snapshot) => {
            const url = snapshot.val();
            if (url) loadImageToMap(url);
        });

        // --- 2. การจัดการบนแผนที่ ---
        map.on('pm:create', (e) => {
            const zoneName = prompt("ชื่อพื้นที่:");
            if (zoneName) {
                const newZoneRef = zonesRef.push();
                newZoneRef.set({
                    name: zoneName,
                    isDone: false,
                    geoJSON: e.layer.toGeoJSON()
                });
            }
            map.removeLayer(e.layer); // ลบ layer ชั่วคราวออก เดี๋ยว Firebase จะส่งกลับมาแบบ Sync
        });

        function renderZoneFromServer(layer, id, name, isDone) {
            layer.zoneId = id;
            layer.zoneName = name;
            layer.isDone = isDone;
            layer.addTo(map);
            layer.bindTooltip(name, { permanent: true, direction: 'center', className: 'zone-label' });
            layer.setStyle(isDone ? {color:'#27ae60',fillColor:'#2ecc71',fillOpacity:0.6} : {color:'gray',fillColor:'gray',fillOpacity:0.3});
            
            allZones[id] = layer;

            layer.on('click', () => {
                if(map.pm.globalEditModeEnabled()) return;
                zonesRef.child(id).update({ isDone: !isDone });
            });
        }

        // --- 3. การอัพโหลดรูป (เซฟลง Cloud) ---
        document.getElementById('uploadInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => imageRef.set(ev.target.result);
            reader.readAsDataURL(file);
        });

        function loadImageToMap(url) {
            const img = new Image();
            img.onload = () => {
                if (imageOverlay) map.removeLayer(imageOverlay);
                const bounds = [[0, 0], [img.height, img.width]];
                imageOverlay = L.imageOverlay(url, bounds).addTo(map);
                map.fitBounds(bounds);
            };
            img.src = url;
        }

        // --- 4. ตารางสรุป ---
        function renderTable() {
            const tbody = document.querySelector('#progressTable tbody');
            tbody.innerHTML = '';
            Object.keys(allZones).forEach(id => {
                const layer = allZones[id];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${layer.zoneName}</strong></td>
                    <td>
                        <input type="checkbox" ${layer.isDone ? 'checked' : ''} onchange="toggleZone('${id}', ${layer.isDone})">
                        ${layer.isDone ? 'เสร็จ' : 'รอดำเนินการ'}
                    </td>
                    <td>
                        <button onclick="deleteZone('${id}')" style="color:red; border:none; background:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleZone(id, currentStatus) {
            zonesRef.child(id).update({ isDone: !currentStatus });
        }

        function deleteZone(id) {
            if(confirm('ลบพื้นที่นี้?')) zonesRef.child(id).remove();
        }
    </script>
</body>
</html>