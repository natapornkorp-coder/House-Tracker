<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SitePro V4 - Project Management</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --dark: #0f172a;
            --bg: #f1f5f9;
            --card: #ffffff;
        }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Sarabun', sans-serif; background: var(--bg); overflow: hidden; }

        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* Navigation */
        .top-nav {
            background: var(--dark); color: white; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; z-index: 1001;
        }

        /* Tab Bar Modern */
        .tab-bar {
            display: flex; background: #e2e8f0; padding: 10px 10px 0 10px; gap: 8px;
            overflow-x: auto; border-bottom: 1px solid #cbd5e1; align-items: flex-end;
        }

        .tab {
            background: #cbd5e1; min-width: 160px; padding: 10px 15px; border-radius: 10px 10px 0 0;
            cursor: pointer; position: relative; transition: 0.3s; border: none;
            display: flex; flex-direction: column; gap: 5px; color: #475569;
        }

        .tab.active { background: white; color: var(--primary); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }

        .tab-header { display: flex; justify-content: space-between; align-items: center; font-size: 13px; font-weight: bold; }
        
        /* Progress Bar ใน Tab */
        .tab-progress-container { width: 100%; background: #94a3b8; height: 4px; border-radius: 2px; overflow: hidden; }
        .tab-progress-fill { height: 100%; background: var(--success); transition: width 0.5s ease; width: 0%; }
        
        .btn-del-tab { font-size: 10px; opacity: 0.5; transition: 0.2s; }
        .btn-del-tab:hover { opacity: 1; color: #ef4444; }

        .btn-add-tab { 
            background: var(--primary); color: white; border: none; padding: 8px 15px; 
            border-radius: 8px; cursor: pointer; margin-bottom: 8px; font-weight: bold;
        }

        /* Map & Content */
        #map-area { flex: 1; position: relative; min-height: 300px; }
        #map { height: 100%; width: 100%; }

        .bottom-panel { height: 35vh; background: white; border-top: 2px solid #e2e8f0; padding: 20px; overflow-y: auto; }

        /* UI Table */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #f1f5f9; font-size: 12px; color: #64748b; }
        td { padding: 12px 10px; border-bottom: 1px solid #f8fafc; font-size: 14px; }

        .upload-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 1000;
            background: var(--dark); color: white; width: 50px; height: 50px;
            border-radius: 25px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
        }

        /* Drag Hint */
        .tab { user-select: none; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="top-nav">
        <div style="font-size: 18px; font-weight: bold;"><i class="fa-solid fa-helmet-safety"></i> SITEPRO V4</div>
        <div id="project-info" style="font-size: 12px; opacity: 0.7;">Online Mode</div>
    </div>

    <div class="tab-bar" id="tabBar">
        </div>

    <div id="map-area">
        <div id="map"></div>
        <button class="upload-btn" onclick="document.getElementById('fileIn').click()"><i class="fa-solid fa-camera"></i></button>
        <input type="file" id="fileIn" style="display:none" accept="image/*">
    </div>

    <div class="bottom-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="display-title" style="margin:0">เลือกโครงการ</h3>
            <button onclick="exportToExcel()" style="background:#f1f5f9; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;"><i class="fa-solid fa-file-export"></i> ส่งออก</button>
        </div>
        <table id="zoneTable">
            <thead>
                <tr>
                    <th>โซน</th>
                    <th>ความคืบหน้า</th>
                    <th style="text-align:right">จัดการ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // --- 1. การตั้งค่า Firebase ---
    const firebaseConfig = {
  apiKey: "AIzaSyCUKIYKjC-bYpNm3o0iJxkQu04vek1W9eI",
  authDomain: "house-45.firebaseapp.com",
  databaseURL: "https://house-45-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "house-45",
  storageBucket: "house-45.firebasestorage.app",
  messagingSenderId: "147246420892",
  appId: "1:147246420892:web:7d84b9ad7337c9e1662e59",
  measurementId: "G-2L3KJ31NC8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- 2. ตัวแปรควบคุมระบบ ---
    let currentId = '';
    let projectList = []; // เก็บ Array ของ ID [id1, id2, id3] เพื่อสลับลำดับ
    let mapLayers = {};
    let currentOverlay;

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2, maxZoom: 4 });
    map.pm.addControls({ position: 'topleft', drawMarker: false, drawCircle: false });

    // --- 3. ฟังก์ชันจัดการ Tab & ลำดับ ---
    function init() {
        // ฟังการเปลี่ยนแปลงของลำดับ Tab
        db.ref('settings/tabOrder').on('value', s => {
            projectList = s.val() || [];
            if (projectList.length > 0 && !currentId) switchTab(projectList[0]);
            renderTabs();
        });
    }

    async function renderTabs() {
        const tabBar = document.getElementById('tabBar');
        tabBar.innerHTML = '';

        for (const id of projectList) {
            const snap = await db.ref('project_info/' + id).once('value');
            const info = snap.val() || { name: 'ไม่มีชื่อ' };
            
            // คำนวณ Progress (Real-time)
            const zonesSnap = await db.ref('zones/' + id).once('value');
            const zones = zonesSnap.val() || {};
            const total = Object.keys(zones).length;
            const done = Object.values(zones).filter(z => z.isDone).length;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;

            const tab = document.createElement('div');
            tab.className = `tab ${id === currentId ? 'active' : ''}`;
            tab.draggable = true;
            
            // Event ลากวางสลับลำดับ
            tab.ondragstart = (e) => e.dataTransfer.setData('text/plain', id);
            tab.ondragover = (e) => e.preventDefault();
            tab.ondrop = (e) => {
                const draggedId = e.dataTransfer.getData('text/plain');
                reorderTabs(draggedId, id);
            };

            tab.onclick = () => switchTab(id);
            tab.innerHTML = `
                <div class="tab-header">
                    <span>${info.name}</span>
                    <i class="fa-solid fa-trash btn-del-tab" onclick="deleteProject(event, '${id}')"></i>
                </div>
                <div style="font-size:10px;">Progress: ${percent}%</div>
                <div class="tab-progress-container">
                    <div class="tab-progress-fill" style="width: ${percent}%"></div>
                </div>
            `;
            tabBar.appendChild(tab);
        }

        const addBtn = document.createElement('button');
        addBtn.className = 'btn-add-tab';
        addBtn.innerText = '+ เพิ่มงาน';
        addBtn.onclick = addNewProject;
        tabBar.appendChild(addBtn);
    }

    function reorderTabs(draggedId, targetId) {
        const fromIndex = projectList.indexOf(draggedId);
        const toIndex = projectList.indexOf(targetId);
        const newList = [...projectList];
        newList.splice(fromIndex, 1);
        newList.splice(toIndex, 0, draggedId);
        db.ref('settings/tabOrder').set(newList);
    }

    async function addNewProject() {
        const name = prompt("ชื่อโครงการ/หน้างาน:");
        if (!name) return;
        const newId = 'p' + Date.now();
        await db.ref('project_info/' + newId).set({ name: name });
        const newList = [...projectList, newId];
        db.ref('settings/tabOrder').set(newList);
        switchTab(newId);
    }

    async function deleteProject(e, id) {
        e.stopPropagation();
        if (!confirm("ยืนยันการลบโครงการนี้? ข้อมูลทั้งหมดจะหายไป")) return;
        await db.ref('project_info/' + id).remove();
        await db.ref('zones/' + id).remove();
        await db.ref('images/' + id).remove();
        const newList = projectList.filter(p => p !== id);
        db.ref('settings/tabOrder').set(newList);
        if (currentId === id) currentId = '';
    }

    // --- 4. การจัดการข้อมูลภายในโปรเจกต์ ---
    function switchTab(id) {
        currentId = id;
        
        // เคลียร์หน้าจอ
        Object.values(mapLayers).forEach(l => map.removeLayer(l));
        mapLayers = {};
        if (currentOverlay) map.removeLayer(currentOverlay);

        db.ref('project_info/' + id).once('value', s => {
            document.getElementById('display-title').innerText = s.val()?.name || id;
        });

        // ฟังรูปภาพ
        db.ref('images/' + id).on('value', s => {
            if (s.val()) {
                const img = new Image();
                img.onload = () => {
                    if (currentOverlay) map.removeLayer(currentOverlay);
                    const bounds = [[0, 0], [img.height, img.width]];
                    currentOverlay = L.imageOverlay(s.val(), bounds).addTo(map);
                    map.fitBounds(bounds);
                };
                img.src = s.val();
            }
        });

        // ฟังโซน
        db.ref('zones/' + id).on('value', s => {
            const data = s.val() || {};
            Object.values(mapLayers).forEach(l => map.removeLayer(l));
            mapLayers = {};
            
            Object.keys(data).forEach(zId => {
                const z = data[zId];
                const layer = L.geoJSON(z.geoJSON).getLayers()[0];
                layer.addTo(map);
                layer.bindTooltip(z.name, { permanent: true, direction: 'center', className: 'tab-header' });
                layer.setStyle({ color: z.isDone ? '#22c55e' : '#94a3b8', fillOpacity: 0.5 });
                
                layer.on('click', () => {
                    if(!map.pm.globalEditModeEnabled()) {
                        db.ref(`zones/${currentId}/${zId}`).update({ isDone: !z.isDone });
                    }
                });
                mapLayers[zId] = layer;
                layer.zoneName = z.name;
                layer.isDone = z.isDone;
            });
            renderTable();
            renderTabs(); // อัปเดต Progress บน Tab
        });
    }

    map.on('pm:create', (e) => {
        const name = prompt("ชื่อโซน:");
        if (name && currentId) {
            db.ref('zones/' + currentId).push({
                name: name,
                isDone: false,
                geoJSON: e.layer.toGeoJSON()
            });
        }
        map.removeLayer(e.layer);
    });

    function renderTable() {
        const tbody = document.querySelector('#zoneTable tbody');
        tbody.innerHTML = '';
        Object.keys(mapLayers).forEach(id => {
            const z = mapLayers[id];
            tbody.innerHTML += `
                <tr>
                    <td><strong>${z.zoneName}</strong></td>
                    <td><span style="color:${z.isDone?'green':'gray'}">${z.isDone?'✓ เสร็จ':'รอคืบหน้า'}</span></td>
                    <td style="text-align:right">
                        <button onclick="db.ref('zones/${currentId}/${id}').remove()" style="border:none; color:red; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
    }

    document.getElementById('fileIn').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => db.ref('images/' + currentId).set(ev.target.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    init();
</script>
</body>
</html>
